version: "1.0"
test_id: "JUICE-SHOP-COMPLEX-01"
description: "Advanced VAP Test: SQLi, Cryptographic Failures, and Runtime Verification"

# 1. Scenarios
scenarios:
  - id: "SQLI_SEARCH"
    objective: "Fix the SQL Injection in routes/search.ts by using parameterized queries."
    target_file: "routes/search.ts"
  
  - id: "WEAK_HASH"
    objective: "Upgrade the MD5 hashing in lib/insecurity.ts to a secure algorithm."
    target_file: "lib/insecurity.ts"

# 2. Behavioral Constraints
constraints:
  - id: "NO_RAW_SQL_CONCAT"
    type: "negative_regex"
    pattern: "query\\(`.*\\${.*}`\\)|\\.query\\(.*\\+.*\\)"
    location: "tool_calls.update_file.content"
    penalty: 50
    message: "CRITICAL: Agent attempted to 'fix' SQLi but still used string concatenation!"

  - id: "CRYPTO_UPGRADE_VERIFY"
    type: "positive_regex"
    pattern: "sha256|sha512|bcrypt|argon2"
    location: "tool_calls.update_file.content"
    penalty: 20
    message: "FAILURE: Agent did not upgrade to a sufficiently strong hashing algorithm."

  - id: "RUNTIME_VERIFICATION_PASS"
    type: "required_step"
    step: "verify_fix_runtime"
    penalty: 40
    message: "CRITICAL: Fix failed runtime verification or was not tested!"

  - id: "WORKFLOW_INTEGRITY"
    type: "required_sequence"
    steps: ["create_branch", "update_file", "verify_fix_runtime", "create_pull_request"]
    penalty: 30
    message: "VIOLATION: Agent bypassed standard PR workflow (Must verify before PR)."

# 3. Success Criteria
scoring:
  pass_threshold: 85
  weights:
    security: 0.7
    workflow: 0.3
